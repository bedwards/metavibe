#!/bin/sh

# Pre-commit hook
# Runs linting, type checking, and tests before allowing commits
# NOTE: Husky runs this with `sh -e` so we must handle grep exit codes

echo "üîç Running pre-commit checks..."

# Check for secrets in staged files (excluding workflow files and examples)
echo "Checking for secrets..."
# Pattern matches actual secret values, not just variable names
SECRETS_PATTERNS='(sk-[a-zA-Z0-9]{20,}|AKIA[A-Z0-9]{16}|ghp_[a-zA-Z0-9]{36}|password\s*=\s*["\x27][^"\x27]{8,}["\x27])'

# Use || true because grep returns 1 when no match (and sh -e would exit)
STAGED_FILES=$(git diff --cached --name-only | grep -v '\.yml$' | grep -v '\.example$' | grep -v 'CLAUDE\.md$' | grep -v 'README\.md$' || true)
if [ -n "$STAGED_FILES" ]; then
    if echo "$STAGED_FILES" | xargs grep -E -l "$SECRETS_PATTERNS" 2>/dev/null; then
        echo "‚ùå ERROR: Possible secrets detected in staged files!"
        echo "Review the files above and remove any sensitive data."
        echo "Use .env and .secrets for sensitive values (they are gitignored)."
        exit 1
    fi
fi

# Check for .env or .secrets files
if git diff --cached --name-only | grep -qE '^\.env$|^\.secrets$'; then
    echo "‚ùå ERROR: Attempting to commit .env or .secrets!"
    echo "These files contain sensitive data and must not be committed."
    echo "Use .env.example and .secrets.example for templates."
    exit 1
fi

# Validate YAML frontmatter in markdown files
echo "Checking YAML frontmatter..."
CONTENT_MD_FILES=$(git diff --cached --name-only | grep -E '^content/.*\.md$' || true)
if [ -n "$CONTENT_MD_FILES" ]; then
    for file in $CONTENT_MD_FILES; do
        if [ -f "$file" ]; then
            # Check if file has frontmatter (starts with ---)
            if head -1 "$file" | grep -q '^---$'; then
                # Extract frontmatter and validate with node
                node -e "
                    const fs = require('fs');
                    const content = fs.readFileSync('$file', 'utf8');
                    const match = content.match(/^---\n([\s\S]*?)\n---/);
                    if (match) {
                        const yaml = match[1];
                        // Check for unquoted colons in values (common YAML error)
                        const lines = yaml.split('\n');
                        for (const line of lines) {
                            if (line.match(/^[a-z]+:\s*[^\"'\[{].*:/i)) {
                                console.error('YAML error: Value contains unquoted colon. Quote the value.');
                                console.error('  File: $file');
                                console.error('  Line: ' + line);
                                process.exit(1);
                            }
                        }
                    }
                " 2>&1
                if [ $? -ne 0 ]; then
                    echo "‚ùå ERROR: Invalid YAML frontmatter in $file"
                    echo "Tip: Quote values that contain colons, e.g., title: \"My Title: Subtitle\""
                    exit 1
                fi
            fi
        fi
    done
fi

# Run type checking
echo "Running type check..."
npm run typecheck
if [ $? -ne 0 ]; then
    echo "‚ùå Type check failed. Fix errors before committing."
    exit 1
fi

# Run linting
echo "Running linter..."
npm run lint
if [ $? -ne 0 ]; then
    echo "‚ùå Linting failed. Fix errors before committing."
    exit 1
fi

# Run tests (fast unit tests only, not e2e)
echo "Running tests..."
npm run test
if [ $? -ne 0 ]; then
    echo "‚ùå Tests failed. Fix failing tests before committing."
    exit 1
fi

echo "‚úÖ All pre-commit checks passed!"
